<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Network of Copernicus Academy and Copernicus Relays</title>
    <!-- leaflet css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />


    <style>
      body{
        margin:0;
        padding:0;
      }
      #map{
        position: relative;
        width: 85%;
        height: 95vh;
        margin: auto;
        margin-top: 20px;
      }
      .filter-container {
      position: absolute;
      width: 200px;
      bottom: 25px;
      left: 10px;
      background-color: white;
      padding: 10px; /* Increase padding for better spacing */
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      }

      .checkbox-row {
      display: flex;
      justify-content: space-between;
      align-items: left;
      margin-top: 5px;
      }

      .filter-container label {
      display: flex;
      align-items: center;
      }

      .filter-container input {
      margin-right: 5px;
      }
      .legend {
        padding: 8px;
        background: white;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        margin: 20px;
        z-index: 999;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 200px;
      }
      label {
        font-family: sans-serif;
        font-size: 13px;
        color: #333;
       margin-right: 5px;
      }
    </style>
  </head>

  <body>
      <div id="map">
        <div class="filter-container">
          <label><strong>Show:</strong></label>
          <div class="checkbox-row">
            <label for="CopAmbsCheckbox">Copernicus Ambassadors</label>
            <input type="checkbox" id="CopAmbsCheckbox" checked>

          </div>      
        </div>        
      </div>
      
  

<!--leaflet js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


<!-- import relays variable from external javascript file -->
<script src="CopernicusAmbassadors.js"></script>



<script> 
  //Map initialization
  const map = L.map('map').setView([49.5, 15],4);

  // GISCO layer
  const giscoLayer = L.tileLayer('https://gisco-services.ec.europa.eu/maps/tiles/OSMCartoComposite/EPSG3857/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://ec.europa.eu/eurostat/web/gisco/overview">EC-GISCO</a> | &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    //attribution: 'Â© OpenStreetMap contributors, Credit: EC-GISCO'
    });
  giscoLayer.addTo(map);

  //MARKERS
  //Icon style
  const myIcon_Orange = L.icon({
    iconUrl: 'https://www.pngall.com/wp-content/uploads/2017/05/Map-Marker-Free-Download-PNG.png',
    iconSize: [25,25],
    });

  const myIcon_Red= L.icon({
    iconUrl: 'https://www.pngall.com/wp-content/uploads/2017/05/Map-Marker-PNG-Picture.png',
    iconSize: [30,30],
    });

  const myIcon_Academy =L.icon({
      iconUrl: 'Academy.svg',
      iconSize: [25,25], 

    });

    const myIcon_Black = L.icon({
    iconUrl: 'https://www.pngall.com/wp-content/uploads/2017/05/Map-Marker-PNG-Clipart.png', // Adjust the URL if needed
    iconSize: [25,25], // Adjust width and height as required
    });

// Function to update marker size based on zoom level
function updateMarkerSize() {
    const currentZoom = map.getZoom();
    // Adjust marker size based on zoom level
    let newSize = [30 * (currentZoom / 5), 30 * (currentZoom / 5)]; // Adjust the multiplier as needed
    // Define maximum size for the icons
    const maxSize = [30, 30]; // Adjust as needed

    // Limit the size of the icons to the maximum size
    newSize = [
        Math.min(newSize[0], maxSize[0]),
        Math.min(newSize[1], maxSize[1])
    ];

    myIcon_Academy.options.iconSize = newSize;
    myIcon_Orange.options.iconSize = newSize;
    myIcon_Red.options.iconSize = newSize;

    // Refresh markers to apply changes
    map.eachLayer(function (layer) {
        if (layer instanceof L.Marker) {
            // Check if the marker's icon is myIcon_Academy
            if (layer.options.icon.options.iconUrl === myIcon_Academy.options.iconUrl) {
                layer.setIcon(L.icon({
                    iconUrl: myIcon_Academy.options.iconUrl,
                    iconSize: newSize,
                }));
            }
            if (layer.options.icon.options.iconUrl === myIcon_Red.options.iconUrl) {layer.setIcon(L.icon({
                    iconUrl: myIcon_Red.options.iconUrl,
                    iconSize: newSize,
                }));
            }
            if (layer.options.icon.options.iconUrl === myIcon_Orange.options.iconUrl) {layer.setIcon(L.icon({
                    iconUrl: myIcon_Orange.options.iconUrl,
                    iconSize: newSize,
                }));
            }
            if (layer.options.icon.options.iconUrl === myIcon_Black.options.iconUrl) {layer.setIcon(L.icon({
                    iconUrl: myIcon_Black.options.iconUrl,
                    iconSize: newSize,
                }));
            }             
        }
    });
}


//Loop through the COP AMBASSADORS and add markers to the cluster group
for (let i = 0; i < CopAmbs.length; i++) {
  const copAmb = CopAmbs[i];
  const coordinates = copAmb.Coordinates.split(',').map(coord => parseFloat(coord.trim()));

  if (!isNaN(coordinates[0]) && !isNaN(coordinates[1])) {
    let popupContentCopAmbs;
    
    //Build popup content 
    popupContentCopAmbs = `
    <strong>${copAmb.Name}</strong><br>
      Primary contact: ${copAmb.Contact}<br>
      Email: <a href="mailto:${copAmb.Email}">${copAmb.Email}</a><br>`;

    //Add link only if academy.Link has a value
    if (copAmb.Link) {
      popupContentCopAmbs += ` <a href="${copAmb.Link}" target="_blank">More info</a>`;
    }

    const marker = L.marker(coordinates, { icon: myIcon_Orange, iconSize: [10, 50]});
    marker.bindPopup(popupContentCopAmbs);
    marker.addTo(map);
  }
};



//Legend
const legend = L.control({position: 'topright'});

legend.onAdd = function (map) {
  const div = L.DomUtil.create('div', 'info legend');
  div.innerHTML += '<img src="https://www.pngall.com/wp-content/uploads/2017/05/Map-Marker-PNG-Picture.png" style="width: 20px; height: 20px;"> EU Space Support Office<br>';
//  div.innerHTML += '<img src="Academy.svg" style="width: 20px; height: 20px;"> Copernicus Academy Members<br>';
  div.innerHTML += '<img src="https://www.pngall.com/wp-content/uploads/2017/05/Map-Marker-Free-Download-PNG.png" style="width: 20px; height: 20px;"> Copernicus Ambassadors<br>';
  return div;
};

legend.addTo(map);


// EUSSO marker layer
const EUSSOLayer = L.layerGroup().addTo(map);
//Standalone popup for EUSSO
const brusselsCoordinates = [50.8403436233206, 4.384885539104331];
const brusselsPopupContent = `
  <strong>EU Space Support Office</strong><br>
  Email: <a href="mailto:support@euspace-programme.eu">support@euspace-programme.eu<br>
  <a href="https://www.copernicus.eu/en">More info`
const brusselsMarker = L.marker(brusselsCoordinates, {icon: myIcon_Red}).bindPopup(brusselsPopupContent).addTo(EUSSOLayer);


// Filter checkboxes
const CopAmbsCheckbox = document.getElementById('CopAmbsCheckbox');
CopAmbsCheckbox.addEventListener('change', updateMarkers);


function updateMarkers() {
  map.eachLayer(function (layer) {
        if (layer instanceof L.Marker && layer !== EUSSOLayer.getLayers()[0]) {
          map.removeLayer(layer);
        }
      });

  // Add copAmb markers if the checkbox is checked
  if (CopAmbsCheckbox.checked) {
    for (let i = 0; i < CopAmbs.length; i++) {
      const copAmb = CopAmbs[i];
      const coordinates = copAmb.Coordinates.split(',').map(coord => parseFloat(coord.trim()));

      if (!isNaN(coordinates[0]) && !isNaN(coordinates[1])) {
        let popupContentCopAmbs = `
        <strong>${copAmb.Name}</strong><br>
        Primary contact: ${copAmb.Contact}<br>
        Email: <a href="mailto:${copAmb.Email}">${copAmb.Email}</a><br>`;
      //Add link only if academy.Link has a value
      if (copAmb.Link) {
          popupContentCopAmbs += ` <a href="${copAmb.Link}" target="_blank">More info</a>`;
        }
        
    const marker = L.marker(coordinates, { icon: myIcon_Orange });
    marker.bindPopup(popupContentCopAmbs);
    marker.addTo(map);
    }
      }
    }

  };

// Listen to the zoomend event on the map
map.on('zoomend', function () {
    updateMarkerSize();
});


//SANITY CHECK 

//number of Copernicus Ambassadors
let totalCopAmbs = 0;

for (let i = 0; i < CopAmbs.length; i++) {
  const copAmb = CopAmbs[i];
  totalCopAmbs++; 
}
console.log("Total Copernicus Ambassadors processed:", totalCopAmbs);

// duplicates Copernicus Ambassadors by Name
function findDuplicateCopernicusByName(CopAmbs) {
  const CopAmbsNames = new Set(); // Set to store unique relay names
  const duplicateCopAmbs = []; // Array to store relays with duplicate names

  for (const copAmb of CopAmbs) {
    const copAmbName = copAmb.Name; // Extract the Name property
    if (CopAmbsNames.has(copAmbName)) { // Check if name already exists
      duplicateCopAmbs.push(copAmb);
    } else {
      CopAmbsNames.add(copAmbName); // Add unique name to the Set
    }
  }

  if (duplicateCopAmbs.length > 0) {
    console.log("Duplicate Copernicus Ambassadors (by Name):", duplicateCopAmbs);
  } else {
    console.log("No duplicate Copernicus Ambassadors Names found.");
  }
}
findDuplicateCopernicusByName(CopAmbs);

// duplicates Copernicus Ambassadors by Coordinates
function findDuplicateCopAmbsCoord(CopAmbs) {
  const copAmbCoords = new Set(); 
  const duplicateCoordCopAmbs = []; 
  for (const copAmb of CopAmbs) {
    const copAmbCoord = copAmb.Coordinates; 
    if (copAmbCoords.has(copAmbCoord)) { 
      duplicateCoordCopAmbs.push(copAmb);
    } else {
      copAmbCoords.add(copAmbCoord); 
    }
  }

  if (duplicateCoordCopAmbs.length > 0) {
    console.log("Duplicate Copernicus Ambassadors Coordinates:", duplicateCoordCopAmbs);
  } else {
    console.log("No duplicate Copernicus Ambassadors Coordinates found.");
  }
}
findDuplicateCopAmbsCoord(CopAmbs);




</script>
</body>
</html>